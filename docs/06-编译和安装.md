# 编译和安装指南

本文档介绍如何编译和安装 Shepherd。

## 快速开始

### 使用 Makefile (推荐)

```bash
# 编译
make build

# 运行
make run

# 安装到系统
sudo make install
```

### 使用编译脚本

```bash
# Linux/macOS
./scripts/build.sh

# Windows
scripts\build.bat
```

## 系统要求

| 平台 | 要求 |
|------|------|
| **Linux** | glibc 2.17+ |
| **macOS** | macOS 10.15+ |
| **Windows** | Windows 10+ |

### 必需软件

- **Go 1.25+** - [下载](https://go.dev/dl/)
- **Git** - [下载](https://git-scm.com/)

## 编译方式

### 方式 1: Makefile (Linux/macOS)

```bash
# 查看所有可用命令
make help

# 编译当前平台
make build

# 跨平台编译
make build-all

# 运行测试
make test

# 代码检查
make lint

# 清理构建文件
make clean
```

### 方式 2: Shell 脚本

#### Linux/macOS

```bash
# 单平台编译
./scripts/build.sh [version]

# 跨平台编译
./scripts/build-all.sh [version]

# 发布打包
./scripts/release.sh [version]
```

#### Windows

```batch
REM 单平台编译
scripts\build.bat [version]
```

### 方式 3: 直接使用 Go 命令

```bash
# 设置 Go 代理（中国大陆）
export GOPROXY=https://goproxy.cn,direct

# 编译
go build -o shepherd cmd/shepherd/main.go

# 指定版本
go build -ldflags "-X main.Version=1.0.0" -o shepherd cmd/shepherd/main.go
```

## 跨平台编译

### 方法 1: 使用脚本

```bash
./scripts/build-all.sh
```

### 方法 2: 手动交叉编译

```bash
# Windows (64位)
GOOS=windows GOARCH=amd64 go build -o shepherd-windows.exe cmd/shepherd/main.go

# macOS (Intel)
GOOS=darwin GOARCH=amd64 go build -o shepherd-macos-amd64 cmd/shepherd/main.go

# macOS (Apple Silicon)
GOOS=darwin GOARCH=arm64 go build -o shepherd-macos-arm64 cmd/shepherd/main.go

# Linux (ARM64)
GOOS=linux GOARCH=arm64 go build -o shepherd-linux-arm64 cmd/shepherd/main.go
```

## 安装

### Linux/macOS

```bash
# 方法 1: 使用 Makefile
sudo make install

# 方法 2: 手动安装
sudo cp shepherd /usr/local/bin/
sudo chmod +x /usr/local/bin/shepherd
```

### Windows

```batch
# 复制到 PATH 目录
copy shepherd.exe C:\Windows\System32\

# 或添加到用户 PATH
copy shepherd.exe %USERPROFILE%\bin\
```

### 使用 Snap (Linux)

```bash
# 安装
sudo snap install shepherd --dangerous --classic

# 列出已安装版本
snap list | grep shepherd

# 卸载
sudo snap remove shepherd
```

## Docker 部署

### 构建镜像

```bash
docker build -t shepherd:latest .
```

### 运行容器

```bash
# 单机模式
docker run -d \
  --name shepherd \
  -p 9190:9190 \
  -v $(pwd)/config:/app/config \
  -v $(pwd)/models:/app/models \
  shepherd:latest

# Master 模式
docker run -d \
  --name shepherd-master \
  -p 9190:9190 \
  -v $(pwd)/config:/app/config \
  shepherd:latest \
  --mode=master

# Client 模式
docker run -d \
  --name shepherd-client \
  -v $(pwd)/config:/app/config \
  shepherd:latest \
  --mode=client \
  --master-address=http://master:9190
```

## 系统服务配置

### systemd (Linux)

创建服务文件 `/etc/systemd/system/shepherd.service`:

```ini
[Unit]
Description=Shepherd Model Server
After=network.target

[Service]
Type=simple
User=shepherd
WorkingDirectory=/opt/shepherd
ExecStart=/opt/shepherd/shepherd --mode=standalone
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable shepherd
sudo systemctl start shepherd
sudo systemctl status shepherd
```

### launchd (macOS)

创建 plist 文件 `~/Library/LaunchAgents/com.shepherd.server.plist`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.shepherd.server</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/local/bin/shepherd</string>
        <string>--mode=standalone</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
</dict>
</plist>
```

加载服务：

```bash
launchctl load ~/Library/LaunchAgents/com.shepherd.server.plist
launchctl start com.shepherd.server
```

### Windows 服务

使用 NSSM (Non-Sucking Service Manager):

```batch
REM 下载 NSSM
REM https://nssm.cc/download

REM 安装服务
nssm install Shepherd C:\shepherd\shepherd.exe --mode=standalone

REM 启动服务
nssm start Shepherd

REM 停止服务
nssm stop Shepherd

REM 卸载服务
nssm remove Shepherd confirm
```

## 验证安装

```bash
# 检查版本
shepherd --version

# 查看帮助
shepherd --help

# 测试运行（单机模式）
shepherd --mode=standalone
```

## 故障排除

### 编译错误

**问题**: `go: command not found`

**解决**: 安装 Go 并添加到 PATH

```bash
# Linux/macOS
export PATH=$PATH:/usr/local/go/bin

# 永久添加到 ~/.bashrc 或 ~/.zshrc
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
```

**问题**: 网络超时

**解决**: 使用国内代理

```bash
export GOPROXY=https://goproxy.cn,direct
```

### 运行时错误

**问题**: 端口已被占用

**解决**: 修改配置文件中的端口号或停止占用进程

```bash
# 查看端口占用
lsof -i :9190

# 停止进程
kill -9 <PID>
```

**问题**: 权限不足

**解决**: 确保有正确的文件权限

```bash
# 日志目录
chmod 755 logs/

# 配置目录
chmod 755 config/
```

## 下一步

- 阅读配置文档
- 运行 Shepherd
- 访问 Web UI: http://localhost:9190
- 配置分布式模式
